---
- debug: msg="START netconf/netconf.yaml on connection={{ ansible_connection }}"


- name: Ensure netconf is enabled
  junos_netconf:
    state: present
  register: result

- name: idempotent tests
  junos_netconf:
    state: present
  register: result

- assert:
    that:
      - "result.changed == false"

###################################

- name: wait for netconf server to come up
  delegate_to: localhost
  wait_for:
    host: "{{ hostvars[item].ansible_host }}"
    port: 830
  with_inventory_hostnames: junos

- name: Ensure we can communicate over netconf
  include: "{{ role_path }}/tests/utils/junos_command.yaml ansible_connection=netconf ansible_port=830 is_ignore_errors=false"

# Disable netconf
- name: Disable netconf
  junos_netconf:
    state: absent
  register: result

- assert:
    that:
      - "result.changed == true"

- name: idempotent tests
  junos_netconf:
    state: absent
  register: result

- assert:
    that:
      - "result.changed == false"

- name: wait for persistent socket to timeout
  pause:
    seconds: 120

- name: Ensure we can NOT talk via netconf
  include: "{{ role_path }}/tests/utils/junos_command.yaml ansible_connection=netconf ansible_port=830 is_ignore_errors=true"

- assert:
    that:
      - "result.failed == true"

- name: re-enable netconf
  junos_netconf:
    state: present
  register: result

- debug: msg="END netconf/netconfg.yaml on connection={{ ansible_connection }}"
